<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
	  <title>The graph adventure!!</title>
		<script src="https://d3js.org/d3.v4.js"></script>
    <!-- <script src="https://d3js.org/d3-selection.v1.min.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script> -->
    <script src="/tools/bubbles.js"></script>
    <script src="/tools/viz.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/quasar@1.12.2/dist/quasar.min.css" rel="stylesheet" type="text/css">
</head>
<body>
<div id="main">
    <div id="board">
        <div class="command" id="command"></div>
        <button onclick="window.open('', '_self', ''); window.close();">Close</button>
        <div id="detail"></div>
    </div>
    <!-- <div id="viz" style="width: 900px; height: 600px"></div> -->
		<div id="graph_viz"></div>
</div>

</br>
</br>
<div id="q-app">
  <div class="q-pa-md q-gutter-sm">
    <levels
      v-for="item in levelList"
      v-bind:level="item"
      v-bind:key="item.id"
    ></levels>
    </br>
    {{ message }}
    </br>
  </div>
<div class="q-pa-md">
    <q-badge color="secondary">
       current date: {{ dates[value] }} ( {{ dates[0] }} to {{ dates[dates.length - 1] }} )
    </q-badge>
    <q-slider
      v-model="value"
      :min="0"
      :max="dates.length - 1"
      :step="1"
      :label-value="dates[value]"
      label
      color="light-green"
      @input="trigger"
    />
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue@^2.0.0/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quasar@1.12.2/dist/quasar.umd.min.js"></script>
<script>
Vue.component('levels', {
  props: ['level'],
  template: '<q-btn color="blue" text-color="black" @click="select_level(level.id)" >{{ level.text }}</q-btn>'
})

var q_app = new Vue({
  el: '#q-app',
  async mounted(){
  /*let bubbleChart = bub.bubbles.create("#viz", bub.XYChart, {"click": onChartClick});
  const detailsDisplay = DetailDisplay(d3.select("#detail"));
  const dimensionPicker = DimensionPicker(d3.select("#command"), onDimensionChanged);*/
    console.log('first creation')
  },
  data: {
    value : 1,
    levelList: [],
    dates: [],
    message : "",
    time_traveller_mode : false,
  },
  methods: {
    trigger(event){ // this function is called whenever the slider is touched
       if(this.value == this.dates.length - 1 ){
         this.time_traveller_mode = false
         console.log("mode false")
       }
       else{
         console.log("mode true")
         this.time_traveller_mode = true
       }
       set_date()
    }
      /*function go() {
      console.log("in go");
      d3.json(`./result/${getResultId()}`).then(
          result => startViz(result, dimensionPicker, detailsDisplay)
      );
      }*/

  }
})
    </script>

<script>

// set the dimensions and margins of the graph
var margin = {top: 10, right: 30, bottom: 30, left: 40},
  width = 800 - margin.left - margin.right,
  height = 800 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select("#graph_viz")
.append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
.append("g")
  .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

function update() {
  //if(!q_app.time_traveller_mode){ 
 //d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/data_network.json", function( data) {
d3.json(`./result/${getResultId()}`, function( data) {

  // Initialize the links
  var link = svg
    .selectAll("line")
    .data(data.links)
    .enter()
    .append("line")
      .style("stroke", "#aaa")

  // Initialize the nodes
  var node = svg
    .selectAll("circle")
    .data(data.nodes)
    .enter()
    .append("circle")
      .attr("r", 20)
      .style("fill", "#69b3a2")

  // Let's list the force we wanna apply on the network
  var simulation = d3.forceSimulation(data.nodes)                 // Force algorithm is applied to data.nodes
      .force("link", d3.forceLink()                               // This force provides links between nodes
            .id(function(d) { return d.id; })                     // This provide  the id of a node
            .links(data.links)                                    // and this the list of links
      )
      .force("charge", d3.forceManyBody().strength(-400))         // This adds repulsion between nodes. Play with the -400 for the repulsion strength
      .force("center", d3.forceCenter(width / 2, height / 2))     // This force attracts nodes to the center of the svg area
      .on("end", ticked);

  // This function is run at each iteration of the force algorithm, updating the nodes position.
  function ticked() {
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node
         .attr("cx", function (d) { return d.x+6; })
         .attr("cy", function(d) { return d.y-6; });
  }
});

/*d3.json(`./result/${getResultId()}`).then(
        result => update_centroids(result, dimensionPicker)
        );*/
    //} endif
  }


</script>


</body>

<script>
  /* let bubbleChart = bub.bubbles.create("#viz", bub.XYChart, {"click": onChartClick});
  const detailsDisplay = DetailDisplay(d3.select("#detail"));
  const dimensionPicker = DimensionPicker(d3.select("#command"), onDimensionChanged);*/

  function set_date(){
    console.log("setting date" + q_app.dates[q_app.value])
    d3.json(`./set_date/${q_app.value}`).then(
    result => update_centroids(result, dimensionPicker) //update_l(result)
  );
  }

  function onChartClick(x, y) {
      const [id] = bubbleChart.getClustersAtPosition(x, y);
      detailsDisplay.detailChanged(id)
      d3.json(`detail_community/${id}`).then(
    result => update_centroids(result, dimensionPicker)
    );
  }

  function onDimensionChanged(data, dimensions) {
      bubbleChart = bub.bubbles.update(bubbleChart, bub.XYChart, {data, dimensions});
  }

  function go() {
      d3.json(`./result/${getResultId()}`).then(
          result => startViz(result, dimensionPicker, detailsDisplay)
      );
  }

function update_l(num_levels){
  console.log("update levels quasar, current date: "+q_app.dates[q_app.value]+ ' index: '+ q_app.value)
  console.log("num_levels "+num_levels.num_of_levels)
	new_button_list = []
	var i
	for(i=1; i<num_levels.num_of_levels+1; i++){
		new_button_list.push({id: i, text : 'level' + i })
	}
	q_app.levelList= new_button_list
  q_app.message = "Current level:" + num_levels.num_of_levels + " with " + num_levels.num_of_com + "communuties"
	return 0
}

function select_level(level){
  d3.json(`./set_level/${level}`).then(
    result => update_l(result)
  );
}

function update_date(result){
  q_app.dates.push(result.last_date)
}

function numlevels(){
	d3.json(`./numlevels`, function(num_levels){
  new_button_list = []
  var i
  for(i=1; i<num_levels.num_of_levels+1; i++){
    new_button_list.push({id: i, text : 'level' + i })
  }
  q_app.levelList= new_button_list
  q_app.message = "Current level:" + num_levels.num_of_levels + " with " + num_levels.num_of_com + "communuties"
	})
}
function last_date(){
	d3.json(`./last_date`, function(jsondata){
	  q_app.dates.push(jsondata.last_date)
		})
}

//go()
//setInterval(go, 2000)
setInterval(update, 2000)
setInterval(numlevels, 2000)
setInterval(last_date, 2000)
</script>

<style>

.btn {
  border: none;
  color: white;
  padding: 5px 5px;
  font-size: 32px;
  cursor: pointer;
}


    #main {
        display: flex;
        padding: 20px;
    }

    #board {
        position: relative;
    }

    .command {
        display: table;
    }

    .command div {
        display: table-row;
    }

    .command div * {
        display: table-cell;
        padding-bottom: .5em;
        padding-right: .5em;
    }

    button {
        color: white;
        background: #4C8FFB;
        border: 1px #3079ED solid;
        box-shadow: inset 0 1px 0 #80B0FB;
        padding: 5px 10px;
        border-radius: 2px;
        font-weight: bold;
        font-size: 9pt;
        outline: none;
        margin-top: 5px;
    }

    #command {
        margin-bottom: 1em;
    }

    #command div select {
        width: 15em;
    }

    #detail {
        padding: .8em .4em 0 .8em;
        position: absolute;
        bottom: 3em;
        width: 100%;
    }

    #detail.active {
        background: lightgrey;
    }

    #detail .caption {
        text-align: left;
        text-decoration: underline;
        font-weight: 700;
        padding-bottom: 5px;
    }

    #detail .values {
        max-height: 21em;
        overflow-y: scroll;
    }

    .cluster {
        pointer-events: visible !important;
        cursor: pointer;
    }
</style>
</html>
